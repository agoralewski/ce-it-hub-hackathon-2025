{% extends "base.html" %}

{% block title %}Przenieś przedmioty - KSP{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Przenieś przedmioty na półkę {{ target_shelf.full_location }}</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6 class="text-muted mb-3">Docelowa lokalizacja</h6>
                        <div class="d-flex align-items-center mb-3">
                            <div class="location-icon me-3">
                                <i class="fas fa-map-marker-alt fa-fw text-primary"></i>
                            </div>
                            <span class="fw-bold">{{ target_shelf.rack.room.name }}</span>
                        </div>
                        <div class="d-flex align-items-center mb-3">
                            <div class="location-icon me-3">
                                <i class="fas fa-grip-vertical fa-fw text-primary"></i>
                            </div>
                            <span class="fw-bold">Regał {{ target_shelf.rack.name }}</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="location-icon me-3">
                                <i class="fas fa-layer-group fa-fw text-primary"></i>
                            </div>
                            <span class="fw-bold">Półka {{ target_shelf.number }}</span>
                        </div>
                    </div>

                    <hr class="my-4">

                    <form method="post" id="moveItemsForm">
                        {% csrf_token %}
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">Wybierz lokalizację źródłową</h6>
                            <div class="row g-3 mb-3">
                                <div class="col-md-4">
                                    <label for="room" class="form-label">Pokój</label>
                                    <select id="room" class="form-select room-select" data-placeholder="Wybierz pokój">
                                        <option value="">Wybierz pokój</option>
                                        {% for room in rooms %}
                                        <option value="{{ room.id }}">{{ room.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="rack" class="form-label">Regał</label>
                                    <select id="rack" class="form-select rack-select" disabled>
                                        <option value="">Wybierz najpierw pokój</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="source_shelf" class="form-label">Półka</label>
                                    <select name="source_shelf" id="source_shelf" class="form-select shelf-select" disabled>
                                        <option value="">Wybierz najpierw regał</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="itemSelectionArea" class="d-none mb-4">
                            <h6 class="text-muted mb-3">Wybierz przedmioty do przeniesienia</h6>
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle"></i> Zaznacz przedmioty, które chcesz przenieść na półkę {{ target_shelf.full_location }}.
                            </div>
                            <div class="table-responsive">
                                <table class="table table-hover" id="itemsTable">
                                    <thead>
                                        <tr>
                                            <th style="width: 50px;">
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" id="selectAll">
                                                </div>
                                            </th>
                                            <th>Nazwa przedmiotu</th>
                                            <th>Kategoria</th>
                                            <th>Producent</th>
                                            <th>Data ważności</th>
                                        </tr>
                                    </thead>
                                    <tbody id="itemsList">
                                        <!-- Items will be loaded dynamically via JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="noItemsMessage" class="alert alert-warning d-none">
                                <i class="fas fa-exclamation-triangle"></i> Brak przedmiotów na wybranej półce.
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{% url 'warehouse:shelf_detail' target_shelf.pk %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Wróć
                            </a>
                            <button type="submit" class="btn btn-primary" id="moveItemsBtn" disabled>
                                <i class="fas fa-exchange-alt"></i> Przenieś zaznaczone przedmioty
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialize Select2 for dropdown fields
        $('.room-select, .rack-select, .shelf-select').select2({
            placeholder: function() {
                return $(this).data('placeholder');
            },
            allowClear: true,
            width: '100%'
        });
        
        // Handle dynamic loading of racks when room changes
        $('#room').on('change', function() {
            var roomId = $(this).val();
            if (roomId) {
                // Clear rack and shelf selects
                $('#rack').empty().trigger('change');
                $('#source_shelf').empty().trigger('change');
                $('#rack').prop('disabled', false);
                $('#source_shelf').prop('disabled', true);
                $('#itemSelectionArea').addClass('d-none');
                $('#moveItemsBtn').prop('disabled', true);
                
                // Fetch racks for this room
                $.ajax({
                    url: "{% url 'warehouse:get_racks' %}",
                    data: {
                        'room_id': roomId
                    },
                    dataType: 'json',
                    success: function(data) {
                        // Add empty option
                        $('#rack').append(new Option('Wybierz regał', '', true, true));
                        
                        // Add rack options
                        $.each(data, function(index, item) {
                            $('#rack').append(new Option(item.name, item.id, false, false));
                        });
                        
                        // Trigger change to update Select2
                        $('#rack').trigger('change');
                    }
                });
            } else {
                $('#rack').prop('disabled', true);
                $('#source_shelf').prop('disabled', true);
                $('#itemSelectionArea').addClass('d-none');
                $('#moveItemsBtn').prop('disabled', true);
            }
        });
        
        // Handle dynamic loading of shelves when rack changes
        $('#rack').on('change', function() {
            var rackId = $(this).val();
            if (rackId) {
                // Clear shelf select
                $('#source_shelf').empty().trigger('change');
                $('#source_shelf').prop('disabled', false);
                $('#itemSelectionArea').addClass('d-none');
                $('#moveItemsBtn').prop('disabled', true);
                
                // Fetch shelves for this rack
                $.ajax({
                    url: "{% url 'warehouse:get_shelves' %}",
                    data: {
                        'rack_id': rackId
                    },
                    dataType: 'json',
                    success: function(data) {
                        // Add empty option
                        $('#source_shelf').append(new Option('Wybierz półkę', '', true, true));
                        
                        // Add shelf options
                        $.each(data, function(index, item) {
                            $('#source_shelf').append(new Option(item.number, item.id, false, false));
                        });
                        
                        // Trigger change to update Select2
                        $('#source_shelf').trigger('change');
                    }
                });
            } else {
                $('#source_shelf').prop('disabled', true);
                $('#itemSelectionArea').addClass('d-none');
                $('#moveItemsBtn').prop('disabled', true);
            }
        });
        
        // Handle shelf selection
        $('#source_shelf').on('change', function() {
            var shelfId = $(this).val();
            
            $('#itemSelectionArea').addClass('d-none');
            $('#moveItemsBtn').prop('disabled', true);
            
            if (shelfId) {
                // Check if the selected shelf is the same as the target shelf
                if (shelfId == {{ target_shelf.id }}) {
                    alert('Nie można przenieść przedmiotów na tę samą półkę.');
                    return;
                }
                
                // Show the item selection area and load items
                $('#itemSelectionArea').removeClass('d-none');
                loadShelfItems(shelfId);
            }
        });
        
        // Load items from a shelf
        function loadShelfItems(shelfId) {
            $('#itemsList').empty();
            $('#noItemsMessage').addClass('d-none');
            
            $.ajax({
                url: '/warehouse/api/shelf_items/',  // You'll need to create this API endpoint
                data: { 'shelf_id': shelfId },
                dataType: 'json',
                success: function(data) {
                    if (data.length > 0) {
                        $.each(data, function(i, item) {
                            const row = `
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input type="checkbox" class="form-check-input item-checkbox" name="item_ids" value="${item.id}">
                                        </div>
                                    </td>
                                    <td>${item.name}</td>
                                    <td>${item.category || '-'}</td>
                                    <td>${item.manufacturer || '-'}</td>
                                    <td>${item.expiration_date || '-'}</td>
                                </tr>
                            `;
                            $('#itemsList').append(row);
                        });
                        
                        // Enable move button when at least one item is selected
                        $('.item-checkbox').on('change', updateMoveButtonState);
                    } else {
                        $('#noItemsMessage').removeClass('d-none');
                    }
                },
                error: function() {
                    $('#noItemsMessage').removeClass('d-none');
                }
            });
        }
        
        // Select/deselect all items
        $('#selectAll').on('change', function() {
            const isChecked = $(this).prop('checked');
            $('.item-checkbox').prop('checked', isChecked);
            updateMoveButtonState();
        });
        
        // Update move button state
        function updateMoveButtonState() {
            const hasSelectedItems = $('.item-checkbox:checked').length > 0;
            $('#moveItemsBtn').prop('disabled', !hasSelectedItems);
        }
    });
</script>
{% endblock %}
