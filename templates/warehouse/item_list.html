{% extends "base.html" %}

{% block title %}Lista przedmiotów - KSP{% endblock %}

{% block extra_css %}
<style>
    .filters-card {
        margin-bottom: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }
    .filter-form .form-select {
        width: 100%;
        margin-bottom: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        color: #495057;
    }
    .filter-form .clear-filters-btn {
        margin-top: 0.5rem;
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        border-radius: 0.25rem;
        cursor: pointer;
    }
    .filter-form .clear-filters-btn:hover {
        background-color: #c82333;
    }

    @media (min-width: 768px) {
        .filter-form {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .filter-form .form-select {
            margin-bottom: 0;
        }
        .filter-form .clear-filters-btn {
            margin-top: 0;
        }
    }

    .fade-out {
        opacity: 0;
        transition: opacity 0.3s ease-out;
    }
    .fade-in {
        opacity: 1;
        transition: opacity 0.3s ease-in;
    }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Lista przedmiotów w magazynie</h5>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="filters-card">
            <form method="get" action="{% url 'warehouse:item_list' %}" class="filter-form">
                <select name="room" class="form-select" data-placeholder="Pokój">
                    <option value="">Pokój</option>
                    {% for room in rooms %}
                    <option value="{{ room.id }}" {% if selected_room == room.id|slugify %}selected{% endif %}>{{ room.name }}</option>
                    {% endfor %}
                </select>
                
                <select name="rack" class="form-select" data-placeholder="Regał">
                    <option value="">Regał</option>
                    {% for rack in racks %}
                    <option value="{{ rack.id }}" {% if selected_rack == rack.id|slugify %}selected{% endif %}>{{ rack.room.name }}.{{ rack.name }}</option>
                    {% endfor %}
                </select>
                
                <select name="shelf" class="form-select" data-placeholder="Półka">
                    <option value="">Półka</option>
                    {% for shelf in shelves %}
                    <option value="{{ shelf.id }}" {% if selected_shelf == shelf.id|slugify %}selected{% endif %}>{{ shelf.rack.room.name }}.{{ shelf.rack.name }}.{{ shelf.number }}</option>
                    {% endfor %}
                </select>
                
                <select name="category" class="form-select" data-placeholder="Kategoria">
                    <option value="">Kategoria</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if selected_category == category.id|slugify %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>

                <button class="clear-filters-btn" title="Wyczyść filtry">
                    <i class="fas fa-trash"></i>
                </button>
            </form>
        </div>
        
        <!-- Items table -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Nazwa</th>
                        <th>Kategoria</th>
                        <th>Producent</th>
                        <th>Data ważności</th>
                        <th>Lokalizacja</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in assignments %}
                    <tr>
                        <td>{{ assignment.item.name }}</td>
                        <td>{{ assignment.item.category.name }}</td>
                        <td>{{ assignment.item.manufacturer|default:"-" }}</td>
                        <td>
                            {% if assignment.item.expiration_date %}
                                {% if assignment.item.expiration_date|date:"Y-m-d" <= today_date|date:"Y-m-d" %}
                                    <span class="badge bg-danger">{{ assignment.item.expiration_date }}</span>
                                {% elif assignment.item.expiration_date|date:"Y-m-d" <= thirty_days_from_now|date:"Y-m-d" %}
                                    <span class="badge bg-warning">{{ assignment.item.expiration_date }}</span>
                                {% else %}
                                    <span class="badge bg-success">{{ assignment.item.expiration_date }}</span>
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'warehouse:shelf_detail' assignment.shelf.pk %}">
                                {{ assignment.shelf.full_location }}
                            </a>
                        </td>
                        <td>
                            <a href="{% url 'warehouse:remove_item_from_shelf' assignment.pk %}" class="btn btn-sm btn-danger">
                                <i class="fas fa-minus"></i> Pobierz
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">Brak przedmiotów spełniających kryteria.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        // Initialize Select2 for all dropdowns
        $('.form-select').select2({
            placeholder: function() {
                return $(this).data('placeholder');
            },
            allowClear: true
        });

        // Automatically submit the form on change
        $('.form-select').on('change', function() {
            $('body').removeClass('fade-in').addClass('fade-out');
            $(this).closest('form').submit();
        });

        // Clear all filters
        $('.clear-filters-btn').on('click', function(e) {
            e.preventDefault();
            $('body').removeClass('fade-in').addClass('fade-out');
            $('.form-select').val(null).trigger('change');
        });

        // Add fade-in class on page load
        $('body').addClass('fade-in');
    });
</script>
{% endblock %}
