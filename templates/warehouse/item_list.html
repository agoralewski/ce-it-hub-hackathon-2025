{% extends "base.html" %}

{% block title %}Lista przedmiotów - KSP{% endblock %}

{% block extra_css %}
<style>
    .filters-card {
        margin-bottom: 1rem;
    }
    .filter-form .form-select {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    @media (min-width: 768px) {
        .filter-form {
            display: flex;
            gap: 1rem;
        }
        .filter-form .form-select {
            margin-bottom: 0;
        }
        .filter-form .btn {
            white-space: nowrap;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header bg-primary text-dark d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Lista przedmiotów w magazynie</h5>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="filters-card">
            <form method="get" action="{% url 'warehouse:item_list' %}" class="filter-form">
                <select name="room" class="form-select">
                    <option value="">Wszystkie pokoje</option>
                    {% for room in rooms %}
                    <option value="{{ room.id }}" {% if selected_room == room.id|slugify %}selected{% endif %}>{{ room.name }}</option>
                    {% endfor %}
                </select>
                
                <select name="rack" class="form-select">
                    <option value="">Wszystkie regały</option>
                    {% for rack in racks %}
                    <option value="{{ rack.id }}" {% if selected_rack == rack.id|slugify %}selected{% endif %}>{{ rack.room.name }}.{{ rack.name }}</option>
                    {% endfor %}
                </select>
                
                <select name="shelf" class="form-select">
                    <option value="">Wszystkie półki</option>
                    {% for shelf in shelves %}
                    <option value="{{ shelf.id }}" {% if selected_shelf == shelf.id|slugify %}selected{% endif %}>{{ shelf.rack.room.name }}.{{ shelf.rack.name }}.{{ shelf.number }}</option>
                    {% endfor %}
                </select>
                
                <select name="category" class="form-select">
                    <option value="">Wszystkie kategorie</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if selected_category == category.id|slugify %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter"></i> Filtruj
                </button>
                
                <a href="{% url 'warehouse:item_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> Wyczyść
                </a>
            </form>
        </div>
        
        <!-- Items table -->
        <div class="table-responsive">
            <table class="table table-striped table-hover warehouse-items-table table-vertical-centered">
                <thead>
                    <tr>
                        <th>Nazwa</th>
                        <th>Kategoria</th>
                        <th>Producent</th>
                        <th>Data ważności</th>
                        <th>Lokalizacja</th>
                        <th class="action-cell">Akcje</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in assignments %}
                    <tr>
                        <td>{{ assignment.item.name }}</td>
                        <td>{{ assignment.item.category.name }}</td>
                        <td>{{ assignment.item.manufacturer|default:"-" }}</td>
                        <td>
                            {% if assignment.item.expiration_date %}
                                {% if assignment.item.expiration_date|date:"Y-m-d" <= today_date|date:"Y-m-d" %}
                                    <span class="badge bg-danger">{{ assignment.item.expiration_date }}</span>
                                {% elif assignment.item.expiration_date|date:"Y-m-d" <= thirty_days_from_now|date:"Y-m-d" %}
                                    <span class="badge bg-warning">{{ assignment.item.expiration_date }}</span>
                                {% else %}
                                    <span class="badge bg-success">{{ assignment.item.expiration_date }}</span>
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'warehouse:shelf_detail' assignment.shelf.pk %}">
                                {{ assignment.shelf.full_location }}
                            </a>
                        </td>
                        <td class="action-cell">
                            <a href="{% url 'warehouse:remove_item_from_shelf' assignment.pk %}" class="btn btn-sm btn-danger">
                                <i class="fas fa-minus"></i> Pobierz
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-3">Brak przedmiotów spełniających kryteria.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Dynamic filtering for racks based on room selection
        $('select[name="room"]').on('change', function() {
            const roomId = $(this).val();
            const rackSelect = $('select[name="rack"]');
            const shelfSelect = $('select[name="shelf"]');
            
            // Reset rack and shelf selects
            rackSelect.html('<option value="">Wszystkie regały</option>');
            shelfSelect.html('<option value="">Wszystkie półki</option>');
            
            if (roomId) {
                // Filter racks by room
                {% for rack in racks %}
                if ('{{ rack.room.id }}' === roomId) {
                    rackSelect.append(`<option value="{{ rack.id }}">{{ rack.room.name }}.{{ rack.name }}</option>`);
                }
                {% endfor %}
            } else {
                // Show all racks
                {% for rack in racks %}
                rackSelect.append(`<option value="{{ rack.id }}">{{ rack.room.name }}.{{ rack.name }}</option>`);
                {% endfor %}
            }
        });
        
        // Dynamic filtering for shelves based on rack selection
        $('select[name="rack"]').on('change', function() {
            const rackId = $(this).val();
            const shelfSelect = $('select[name="shelf"]');
            
            // Reset shelf select
            shelfSelect.html('<option value="">Wszystkie półki</option>');
            
            if (rackId) {
                // Filter shelves by rack
                {% for shelf in shelves %}
                if ('{{ shelf.rack.id }}' === rackId) {
                    shelfSelect.append(`<option value="{{ shelf.id }}">{{ shelf.rack.room.name }}.{{ shelf.rack.name }}.{{ shelf.number }}</option>`);
                }
                {% endfor %}
            } else {
                // Show all shelves
                {% for shelf in shelves %}
                shelfSelect.append(`<option value="{{ shelf.id }}">{{ shelf.rack.room.name }}.{{ shelf.rack.name }}.{{ shelf.number }}</option>`);
                {% endfor %}
            }
        });
    });
</script>
{% endblock %}
