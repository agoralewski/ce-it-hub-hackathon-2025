{% extends "base.html" %}

{% block title %}Lista przedmiotów - KSP{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
{% endblock %}

{% block content %}
<div class="card shadow mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Lista przedmiotów w magazynie</h5>
    </div>
    <div class="card-body">
        <!-- Filters -->
        <div class="filters-card">
            <form method="get" action="{% url 'warehouse:item_list' %}" class="filter-form" id="item-filter-form">
                <select name="room" class="form-select" data-placeholder="Pokój" id="room-select">
                    <option value="">Pokój</option>
                    {% for room in rooms %}
                    <option value="{{ room.id }}" {% if selected_room == room.id|slugify %}selected{% endif %}>{{ room.name }}</option>
                    {% endfor %}
                </select>
                
                <select name="rack" class="form-select" data-placeholder="Regał" id="rack-select">
                    <option value="">Regał</option>
                    {% for rack in racks %}
                    <option value="{{ rack.id }}" 
                            data-room="{{ rack.room.id }}"
                            {% if selected_rack == rack.id|slugify %}selected{% endif %}>
                        {{ rack.room.name }}.{{ rack.name }}
                    </option>
                    {% endfor %}
                </select>
                
                <select name="shelf" class="form-select" data-placeholder="Półka" id="shelf-select">
                    <option value="">Półka</option>
                    {% for shelf in shelves %}
                    <option value="{{ shelf.id }}" 
                            data-rack="{{ shelf.rack.id }}"
                            data-room="{{ shelf.rack.room.id }}"
                            {% if selected_shelf == shelf.id|slugify %}selected{% endif %}>
                        {{ shelf.rack.room.name }}.{{ shelf.rack.name }}.{{ shelf.number }}
                    </option>
                    {% endfor %}
                </select>
                
                <select name="category" class="form-select" data-placeholder="Kategoria" id="category-select">
                    <option value="">Kategoria</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if selected_category == category.id|slugify %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>

                <button type="button" class="clear-filters-btn" title="Wyczyść filtry" id="clear-filters">
                    <i class="fas fa-trash"></i>
                </button>
            </form>
        </div>
        
        <!-- Items table -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Nazwa</th>
                        <th>Kategoria</th>
                        <th>Producent</th>
                        <th>Data ważności</th>
                        <th>Lokalizacja</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody>
                    {% for assignment in assignments %}
                    <tr>
                        <td>{{ assignment.item.name }}</td>
                        <td>{{ assignment.item.category.name }}</td>
                        <td>{{ assignment.item.manufacturer|default:"-" }}</td>
                        <td>
                            {% if assignment.item.expiration_date %}
                                {% with today_date|date:"Y-m-d" as today %}
                                {% with thirty_days_from_now|date:"Y-m-d" as soon %}
                                    {% if assignment.item.expiration_date|date:"Y-m-d" < today %}
                                        <span class="badge bg-danger">{{ assignment.item.expiration_date }}</span>
                                    {% elif assignment.item.expiration_date|date:"Y-m-d" <= soon %}
                                        <span class="badge bg-warning">{{ assignment.item.expiration_date }}</span>
                                    {% else %}
                                        <span class="badge bg-success">{{ assignment.item.expiration_date }}</span>
                                    {% endif %}
                                {% endwith %}
                                {% endwith %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <a href="{% url 'warehouse:shelf_detail' assignment.shelf.pk %}">
                                {{ assignment.shelf.full_location }}
                            </a>
                        </td>
                        <td>
                            <a href="{% url 'warehouse:remove_item_from_shelf' assignment.pk %}" class="btn btn-sm btn-danger">
                                <i class="fas fa-minus"></i> Pobierz
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center">Brak przedmiotów spełniających kryteria.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        // Store all options for reverting later
        const allRacks = [];
        const allShelves = [];
        let form = $('#item-filter-form');
        let roomSelect = $('#room-select');
        let rackSelect = $('#rack-select');
        let shelfSelect = $('#shelf-select');
        let categorySelect = $('#category-select');
        
        // Initialize Select2
        $('.form-select').select2({
            placeholder: function() {
                return $(this).data('placeholder');
            },
            allowClear: true,
            templateResult: formatOption
        });
        
        // Formatting function for Select2 options
        function formatOption(option) {
            if (!option.id) {
                return option.text;
            }
            
            const $option = $(option.element);
            
            if ($option.hasClass('invalidated-option')) {
                const $result = $('<span></span>');
                $result.text(option.text);
                $result.addClass('select2-results__option--invalidated');
                return $result;
            }
            
            return option.text;
        }
        
        // Store initial rack options
        rackSelect.find('option').each(function() {
            allRacks.push({
                id: $(this).val(),
                text: $(this).text(),
                roomId: $(this).data('room')
            });
        });
        
        // Store initial shelf options
        shelfSelect.find('option').each(function() {
            allShelves.push({
                id: $(this).val(),
                text: $(this).text(),
                rackId: $(this).data('rack'),
                roomId: $(this).data('room')
            });
        });
        
        // Handle room selection change
        roomSelect.on('change', function(e, skipUpdate) {
            if (skipUpdate) return;
            
            const selectedRoomId = $(this).val();
            
            // If room is selected, it should invalidate incompatible lower-level selections
            if (selectedRoomId) {
                // Clear rack selection if it doesn't belong to selected room
                const selectedRackId = rackSelect.val();
                if (selectedRackId) {
                    const rackRoomId = rackSelect.find(`option[value="${selectedRackId}"]`).data('room');
                    if (rackRoomId != selectedRoomId) {
                        rackSelect.val(null).trigger('change', [true]);
                    }
                }
                
                // Clear shelf selection if it doesn't belong to selected room
                const selectedShelfId = shelfSelect.val();
                if (selectedShelfId) {
                    const shelfRoomId = shelfSelect.find(`option[value="${selectedShelfId}"]`).data('room');
                    if (shelfRoomId != selectedRoomId) {
                        shelfSelect.val(null).trigger('change', [true]);
                    }
                }
            }
            
            updateFilterOptions();
            
            if (!skipUpdate) {
                submitForm();
            }
        });
        
        // Handle rack selection change
        rackSelect.on('change', function(e, skipUpdate) {
            if (skipUpdate) return;
            
            const selectedRackId = $(this).val();
            
            // If rack is selected, it should invalidate incompatible shelf selections
            if (selectedRackId) {
                // Clear shelf selection if it doesn't belong to selected rack
                const selectedShelfId = shelfSelect.val();
                if (selectedShelfId) {
                    const shelfRackId = shelfSelect.find(`option[value="${selectedShelfId}"]`).data('rack');
                    if (shelfRackId != selectedRackId) {
                        shelfSelect.val(null).trigger('change', [true]);
                    }
                }
            }
            
            updateFilterOptions();
            
            if (!skipUpdate) {
                submitForm();
            }
        });
        
        // Handle shelf selection change
        shelfSelect.on('change', function(e, skipUpdate) {
            if (skipUpdate) return;
            updateFilterOptions();
            
            if (!skipUpdate) {
                submitForm();
            }
        });
        
        // Category select change
        categorySelect.on('change', function(e, skipUpdate) {
            if (skipUpdate) return;
            
            if (!skipUpdate) {
                submitForm();
            }
        });
        
        // Update all filter options based on current selections
        function updateFilterOptions() {
            const selectedRoomId = roomSelect.val();
            const selectedRackId = rackSelect.val();
            const selectedShelfId = shelfSelect.val();
            
            // Reset all options first
            resetOptions();
            
            // If a room is selected
            if (selectedRoomId) {
                // Mark racks from other rooms as invalidated
                rackSelect.find('option').each(function() {
                    if ($(this).val() === '') return; // Skip the empty option
                    
                    const rackRoomId = $(this).data('room');
                    if (rackRoomId != selectedRoomId) {
                        $(this).addClass('invalidated-option');
                    }
                });
                
                // Mark shelves from other rooms as invalidated
                shelfSelect.find('option').each(function() {
                    if ($(this).val() === '') return; // Skip the empty option
                    
                    const shelfRoomId = $(this).data('room');
                    if (shelfRoomId != selectedRoomId) {
                        $(this).addClass('invalidated-option');
                    }
                });
            }
            
            // If a rack is selected
            if (selectedRackId) {
                // Mark shelves from other racks as invalidated
                shelfSelect.find('option').each(function() {
                    if ($(this).val() === '') return; // Skip the empty option
                    
                    const shelfRackId = $(this).data('rack');
                    if (shelfRackId != selectedRackId) {
                        $(this).addClass('invalidated-option');
                    }
                });
                
                // Mark rooms that don't contain this rack as invalidated
                if (!selectedRoomId) {
                    const rackRoomId = rackSelect.find(`option[value="${selectedRackId}"]`).data('room');
                    roomSelect.find('option').each(function() {
                        if ($(this).val() === '') return; // Skip the empty option
                        
                        if ($(this).val() != rackRoomId) {
                            $(this).addClass('invalidated-option');
                        }
                    });
                }
            }
            
            // If a shelf is selected
            if (selectedShelfId) {
                const shelfOption = shelfSelect.find(`option[value="${selectedShelfId}"]`);
                const shelfRackId = shelfOption.data('rack');
                const shelfRoomId = shelfOption.data('room');
                
                // If no rack is selected, mark racks that don't contain this shelf as invalidated
                if (!selectedRackId) {
                    rackSelect.find('option').each(function() {
                        if ($(this).val() === '') return; // Skip the empty option
                        
                        if ($(this).val() != shelfRackId) {
                            $(this).addClass('invalidated-option');
                        }
                    });
                }
                
                // If no room is selected, mark rooms that don't contain this shelf as invalidated
                if (!selectedRoomId) {
                    roomSelect.find('option').each(function() {
                        if ($(this).val() === '') return; // Skip the empty option
                        
                        if ($(this).val() != shelfRoomId) {
                            $(this).addClass('invalidated-option');
                        }
                    });
                }
            }
            
            // Refresh Select2 to show new option states
            $('.form-select').select2({
                placeholder: function() {
                    return $(this).data('placeholder');
                },
                allowClear: true,
                templateResult: formatOption
            });
        }
        
        // Reset all options to original state
        function resetOptions() {
            roomSelect.find('option').removeClass('invalidated-option');
            rackSelect.find('option').removeClass('invalidated-option');
            shelfSelect.find('option').removeClass('invalidated-option');
        }
        
        // Submit form
        function submitForm() {
            $('body').removeClass('fade-in').addClass('fade-out');
            $(form).submit();
        }
        
        // Clear all filters
        $('#clear-filters').on('click', function(e) {
            e.preventDefault();
            $('body').removeClass('fade-in').addClass('fade-out');
            
            // Reset all selects
            $('.form-select').val(null).trigger('change', [true]);
            
            // Clear URL parameters and reload
            window.location.href = '{% url "warehouse:item_list" %}';
        });
        
        // Add fade-in class on page load
        $('body').addClass('fade-in');
        
        // Initialize filters on page load
        updateFilterOptions();
    });
</script>
{% endblock %}
